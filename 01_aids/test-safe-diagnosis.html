<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Safe Diagnosis</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .result { margin: 10px 0; padding: 10px; border-radius: 3px; }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .info { background: #d1ecf1; color: #0c5460; }
        .step { margin: 20px 0; padding: 15px; border: 1px solid #ccc; }
        .error-details { background: #2d3748; color: #e2e8f0; padding: 10px; margin: 10px 0; border-radius: 3px; font-family: monospace; font-size: 12px; }
    </style>
</head>
<body>
    <h1>ğŸ” Safe Diagnosis - ã‚¨ãƒ©ãƒ¼ç‰¹å®š</h1>
    
    <div class="step">
        <h2>Step 1: åŸºæœ¬ã‚·ã‚¹ãƒ†ãƒ èª­ã¿è¾¼ã¿</h2>
        <div id="step1-result" class="result info">é–‹å§‹...</div>
    </div>
    
    <div class="step">
        <h2>Step 2: ã‚¨ãƒ©ãƒ¼è©³ç´°ã‚­ãƒ£ãƒ—ãƒãƒ£</h2>
        <div id="error-capture" class="result info">ç›£è¦–ä¸­...</div>
        <div id="error-details" class="error-details"></div>
    </div>
    
    <div class="step">
        <h2>Step 3: DOMè¦ç´ ãƒã‚§ãƒƒã‚¯</h2>
        <div id="dom-check" class="result info">å¾…æ©Ÿä¸­...</div>
    </div>

    <!-- æ„ŸæŸ“ç—‡è¨­å®š -->
    <script>
        window.DISEASE_TYPE = 'aids';
        window.DIAGNOSIS_MODE = true;
        
        // ã‚¨ãƒ©ãƒ¼ã‚­ãƒ£ãƒ—ãƒãƒ£å¼·åŒ–
        const errorLog = [];
        
        window.addEventListener('error', (event) => {
            const errorInfo = {
                message: event.error?.message || event.message,
                filename: event.filename,
                lineno: event.lineno,
                colno: event.colno,
                stack: event.error?.stack,
                timestamp: new Date().toISOString()
            };
            errorLog.push(errorInfo);
            
            console.error('ğŸš¨ Captured Error:', errorInfo);
            
            document.getElementById('error-capture').innerHTML = `âŒ ã‚¨ãƒ©ãƒ¼æ¤œå‡º: ${errorInfo.message}`;
            document.getElementById('error-capture').className = 'result error';
            
            document.getElementById('error-details').innerHTML = `
                <strong>ã‚¨ãƒ©ãƒ¼è©³ç´°:</strong><br>
                Message: ${errorInfo.message}<br>
                File: ${errorInfo.filename}<br>
                Line: ${errorInfo.lineno}:${errorInfo.colno}<br>
                Stack:<br>${(errorInfo.stack || 'No stack').split('\n').slice(0, 5).join('\n')}
            `;
        });
        
        // æœªå‡¦ç†ãƒ—ãƒ­ãƒŸã‚¹æ‹’å¦ã‚‚ã‚­ãƒ£ãƒ—ãƒãƒ£
        window.addEventListener('unhandledrejection', (event) => {
            const errorInfo = {
                reason: event.reason?.message || event.reason,
                stack: event.reason?.stack,
                timestamp: new Date().toISOString()
            };
            errorLog.push(errorInfo);
            
            console.error('ğŸš¨ Unhandled Promise Rejection:', errorInfo);
            
            document.getElementById('error-capture').innerHTML = `âŒ Promiseæ‹’å¦: ${errorInfo.reason}`;
            document.getElementById('error-capture').className = 'result error';
        });
        
        function updateResult(elementId, message, type) {
            const element = document.getElementById(elementId);
            if (element) {
                element.innerHTML = message;
                element.className = `result ${type}`;
            }
        }
        
        // æ®µéšçš„èª­ã¿è¾¼ã¿ãƒ†ã‚¹ãƒˆ
        async function safeLoadingTest() {
            try {
                updateResult('step1-result', 'ğŸ”„ ã‚¹ãƒ†ãƒƒãƒ—1: åŸºæœ¬è¨­å®šç¢ºèª...', 'info');
                
                // åŸºæœ¬å¤‰æ•°ç¢ºèª
                if (window.DISEASE_TYPE && window.DIAGNOSIS_MODE) {
                    updateResult('step1-result', 'âœ… ã‚¹ãƒ†ãƒƒãƒ—1: åŸºæœ¬è¨­å®šOK', 'success');
                } else {
                    updateResult('step1-result', 'âŒ ã‚¹ãƒ†ãƒƒãƒ—1: åŸºæœ¬è¨­å®šå¤±æ•—', 'error');
                    return;
                }
                
                await new Promise(resolve => setTimeout(resolve, 500));
                
                // DOMè¦ç´ ãƒã‚§ãƒƒã‚¯
                updateResult('dom-check', 'ğŸ”„ DOMè¦ç´ ãƒã‚§ãƒƒã‚¯ä¸­...', 'info');
                
                const requiredElements = [
                    'step1-result', 'error-capture', 'dom-check', 'error-details'
                ];
                
                const missingElements = [];
                for (const id of requiredElements) {
                    if (!document.getElementById(id)) {
                        missingElements.push(id);
                    }
                }
                
                if (missingElements.length === 0) {
                    updateResult('dom-check', 'âœ… DOMè¦ç´ : ã™ã¹ã¦å­˜åœ¨', 'success');
                } else {
                    updateResult('dom-check', `âŒ DOMè¦ç´ : ${missingElements.join(', ')} ãŒä¸è¶³`, 'error');
                }
                
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                // ã‚¹ã‚¯ãƒªãƒ—ãƒˆèª­ã¿è¾¼ã¿é–‹å§‹ã®é€šçŸ¥
                updateResult('error-capture', 'ğŸ”„ å¤–éƒ¨ã‚¹ã‚¯ãƒªãƒ—ãƒˆèª­ã¿è¾¼ã¿é–‹å§‹...', 'info');
                
            } catch (error) {
                updateResult('step1-result', `âŒ ãƒ†ã‚¹ãƒˆå¤±æ•—: ${error.message}`, 'error');
                console.error('Safe loading test failed:', error);
            }
        }
        
        // å³åº§ã«ãƒ†ã‚¹ãƒˆé–‹å§‹
        window.addEventListener('load', safeLoadingTest);
    </script>
    
    <!-- æ®µéšçš„ã«å¤–éƒ¨ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’èª­ã¿è¾¼ã¿ -->
    <script>
        console.log('ğŸ“„ Loading disease-config.js...');
    </script>
    <script src="../shared/assets/js/config/disease-config.js"></script>
    
    <script>
        console.log('ğŸ“„ Loading config-loader.js...');
    </script>
    <script src="../shared/assets/js/utils/config-loader.js"></script>
    
    <script>
        console.log('ğŸ“„ Loading defaults.js...');
    </script>
    <script src="../shared/assets/js/config/defaults.js"></script>
    
    <script>
        console.log('ğŸ“„ Loading pubsub.js...');
    </script>
    <script src="../shared/assets/js/pubsub.js"></script>
    
    <!-- ã“ã“ã¾ã§ã¯å®‰å…¨ãªã¯ãšã€‚main.jsã¯å¾Œã§å€‹åˆ¥ãƒ†ã‚¹ãƒˆ -->
    
    <script>
        // èª­ã¿è¾¼ã¿å®Œäº†å¾Œã®ç¢ºèª
        setTimeout(() => {
            const loadedSystems = {
                'DiseaseDetector': !!window.DiseaseDetector,
                'ConfigLoader': !!window.ConfigLoader,
                'PubSub': !!window.pubsub
            };
            
            const loadedCount = Object.values(loadedSystems).filter(Boolean).length;
            
            if (loadedCount >= 2) {
                document.getElementById('error-capture').innerHTML = 
                    `âœ… åŸºæœ¬ã‚·ã‚¹ãƒ†ãƒ èª­ã¿è¾¼ã¿æˆåŠŸ (${loadedCount}/3)<br>` +
                    Object.entries(loadedSystems).map(([name, loaded]) => 
                        `${loaded ? 'âœ…' : 'âŒ'} ${name}`
                    ).join('<br>');
                document.getElementById('error-capture').className = 'result success';
                
                // main.jsã‚’å€‹åˆ¥ãƒ†ã‚¹ãƒˆã™ã‚‹ã‹ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ç¢ºèª
                setTimeout(() => {
                    if (confirm('åŸºæœ¬ã‚·ã‚¹ãƒ†ãƒ ãŒæ­£å¸¸ã§ã™ã€‚main.jsèª­ã¿è¾¼ã¿ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã—ã¾ã™ã‹ï¼Ÿ\n(ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã™ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™)')) {
                        loadMainJS();
                    }
                }, 1000);
                
            } else {
                document.getElementById('error-capture').innerHTML = 
                    `âŒ ã‚·ã‚¹ãƒ†ãƒ èª­ã¿è¾¼ã¿ä¸è¶³ (${loadedCount}/3)`;
                document.getElementById('error-capture').className = 'result error';
            }
        }, 2000);
        
        function loadMainJS() {
            document.getElementById('error-capture').innerHTML = 'ğŸ”„ main.jsèª­ã¿è¾¼ã¿ä¸­...';
            document.getElementById('error-capture').className = 'result info';
            
            const script = document.createElement('script');
            script.src = '../shared/assets/js/main.js';
            script.onload = () => {
                document.getElementById('error-capture').innerHTML = 'âœ… main.jsèª­ã¿è¾¼ã¿æˆåŠŸ';
                document.getElementById('error-capture').className = 'result success';
            };
            script.onerror = (error) => {
                document.getElementById('error-capture').innerHTML = 'âŒ main.jsèª­ã¿è¾¼ã¿å¤±æ•—';
                document.getElementById('error-capture').className = 'result error';
            };
            
            document.head.appendChild(script);
        }
    </script>
</body>
</html>