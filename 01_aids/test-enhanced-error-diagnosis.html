<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enhanced Error Diagnosis</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 1200px; margin: 0 auto; }
        .test-section { margin: 15px 0; padding: 15px; background: white; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .result { margin: 10px 0; padding: 12px; border-radius: 6px; }
        .success { background: #d4edda; color: #155724; border-left: 4px solid #28a745; }
        .error { background: #f8d7da; color: #721c24; border-left: 4px solid #dc3545; }
        .warning { background: #fff3cd; color: #856404; border-left: 4px solid #ffc107; }
        .info { background: #d1ecf1; color: #0c5460; border-left: 4px solid #17a2b8; }
        .loading { background: #e2e3e5; color: #6c757d; border-left: 4px solid #6c757d; }
        .error-details { background: #2d3748; color: #e2e8f0; padding: 15px; margin: 10px 0; border-radius: 6px; font-family: monospace; font-size: 12px; white-space: pre-wrap; max-height: 300px; overflow-y: auto; }
        .stack-trace { background: #1a202c; color: #cbd5e0; padding: 10px; border-radius: 4px; font-family: monospace; font-size: 11px; margin: 5px 0; }
        .highlight-error { background: #fed7d7; color: #c53030; font-weight: bold; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”¬ Enhanced Error Diagnosis</h1>
        <p>è©³ç´°ãªã‚¨ãƒ©ãƒ¼æƒ…å ±ã¨ç™ºç”Ÿç®‡æ‰€ã‚’ç‰¹å®šã—ã¾ã™</p>
        
        <div class="test-section">
            <h2>ã‚¨ãƒ©ãƒ¼ç›£è¦–ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</h2>
            <div id="error-monitor" class="result info">ç›£è¦–é–‹å§‹...</div>
            <div id="error-stack" class="error-details"></div>
        </div>

        <div class="test-section">
            <h2>æ®µéšçš„èª­ã¿è¾¼ã¿ãƒ†ã‚¹ãƒˆ</h2>
            <div id="loading-status" class="result loading">æº–å‚™ä¸­...</div>
            <div id="loading-details" class="error-details"></div>
        </div>

        <div class="test-section">
            <h2>DOMè¦ç´ å­˜åœ¨ãƒã‚§ãƒƒã‚¯</h2>
            <div id="dom-check" class="result loading">å¾…æ©Ÿä¸­...</div>
            <div id="dom-details" class="error-details"></div>
        </div>
    </div>

    <!-- æ„ŸæŸ“ç—‡è¨­å®š -->
    <script>
        window.DISEASE_TYPE = 'aids';
        window.DIAGNOSIS_MODE = true;
        
        // å¼·åŒ–ã•ã‚ŒãŸã‚¨ãƒ©ãƒ¼ã‚­ãƒ£ãƒ—ãƒãƒ£ã‚·ã‚¹ãƒ†ãƒ 
        const errorLog = [];
        let errorCount = 0;
        
        // è©³ç´°ãªã‚¨ãƒ©ãƒ¼æƒ…å ±ã‚’ã‚­ãƒ£ãƒ—ãƒãƒ£
        function setupEnhancedErrorCapture() {
            // JavaScript ã‚¨ãƒ©ãƒ¼
            window.addEventListener('error', (event) => {
                errorCount++;
                const errorInfo = {
                    id: errorCount,
                    type: 'JavaScript Error',
                    message: event.error?.message || event.message,
                    filename: event.filename,
                    lineno: event.lineno,
                    colno: event.colno,
                    stack: event.error?.stack,
                    element: event.target?.tagName,
                    timestamp: new Date().toISOString(),
                    userAgent: navigator.userAgent
                };
                
                errorLog.push(errorInfo);
                displayError(errorInfo);
            });
            
            // Promiseæ‹’å¦
            window.addEventListener('unhandledrejection', (event) => {
                errorCount++;
                const errorInfo = {
                    id: errorCount,
                    type: 'Promise Rejection',
                    message: event.reason?.message || event.reason,
                    stack: event.reason?.stack,
                    timestamp: new Date().toISOString()
                };
                
                errorLog.push(errorInfo);
                displayError(errorInfo);
            });
            
            // console.error ã‚’ã‚¤ãƒ³ã‚¿ãƒ¼ã‚»ãƒ—ãƒˆ
            const originalConsoleError = console.error;
            console.error = function(...args) {
                errorCount++;
                const errorInfo = {
                    id: errorCount,
                    type: 'Console Error',
                    message: args.join(' '),
                    args: args,
                    stack: new Error().stack,
                    timestamp: new Date().toISOString()
                };
                
                errorLog.push(errorInfo);
                displayError(errorInfo);
                
                // å…ƒã®console.errorã‚‚å®Ÿè¡Œ
                originalConsoleError.apply(console, args);
            };
            
            updateStatus('error-monitor', 'ã‚¨ãƒ©ãƒ¼ç›£è¦–é–‹å§‹ âœ…', 'success');
        }
        
        function displayError(errorInfo) {
            updateStatus('error-monitor', `âŒ ã‚¨ãƒ©ãƒ¼ #${errorInfo.id}: ${errorInfo.type}`, 'error');
            
            const stackDisplay = document.getElementById('error-stack');
            const errorElement = document.createElement('div');
            errorElement.className = 'stack-trace';
            
            let stackInfo = `[Error #${errorInfo.id}] ${errorInfo.type}
Timestamp: ${errorInfo.timestamp}
Message: ${errorInfo.message}`;
            
            if (errorInfo.filename) {
                stackInfo += `
File: ${errorInfo.filename}
Line: ${errorInfo.lineno}:${errorInfo.colno}`;
            }
            
            if (errorInfo.stack) {
                stackInfo += `
Stack Trace:
${errorInfo.stack}`;
            }
            
            errorElement.textContent = stackInfo;
            stackDisplay.appendChild(errorElement);
            
            // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã—ã¦æœ€æ–°ã‚¨ãƒ©ãƒ¼ã‚’è¡¨ç¤º
            stackDisplay.scrollTop = stackDisplay.scrollHeight;
        }
        
        function updateStatus(elementId, message, type) {
            const element = document.getElementById(elementId);
            if (element) {
                element.textContent = message;
                element.className = `result ${type}`;
            }
        }
        
        function updateDetails(elementId, details) {
            const element = document.getElementById(elementId);
            if (element) {
                element.textContent = details;
            }
        }
        
        // DOMè¦ç´ ãƒã‚§ãƒƒã‚¯
        function checkDOMElements() {
            updateStatus('dom-check', 'DOMè¦ç´ ãƒã‚§ãƒƒã‚¯ä¸­...', 'loading');
            
            const requiredElements = [
                'container',
                'fixed-background',
                'chart-container',
                'map-container', 
                'image-container',
                'scroll-content',
                'city-steps-container'
            ];
            
            const results = [];
            const missingElements = [];
            
            requiredElements.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    results.push(`âœ… #${id}: å­˜åœ¨`);
                } else {
                    results.push(`âŒ #${id}: ä¸è¶³`);
                    missingElements.push(id);
                }
            });
            
            if (missingElements.length === 0) {
                updateStatus('dom-check', 'DOMè¦ç´ : ã™ã¹ã¦å­˜åœ¨ âœ…', 'success');
            } else {
                updateStatus('dom-check', `DOMè¦ç´ : ${missingElements.length}å€‹ä¸è¶³ âŒ`, 'error');
            }
            
            updateDetails('dom-details', results.join('\n'));
        }
        
        // æ®µéšçš„èª­ã¿è¾¼ã¿ãƒ†ã‚¹ãƒˆ
        async function testStageByStage() {
            updateStatus('loading-status', 'Stage 1: ã‚·ã‚¹ãƒ†ãƒ èª­ã¿è¾¼ã¿ä¸­...', 'loading');
            
            const stages = [
                {
                    name: 'Disease Config',
                    test: () => window.DiseaseDetector,
                    script: '../shared/assets/js/config/disease-config.js'
                },
                {
                    name: 'Config Loader',
                    test: () => window.ConfigLoader,
                    script: '../shared/assets/js/utils/config-loader.js'
                },
                {
                    name: 'PubSub',
                    test: () => window.pubsub,
                    script: '../shared/assets/js/pubsub.js'
                },
                {
                    name: 'Error Handler',
                    test: () => window.ErrorHandler,
                    script: '../shared/assets/js/utils/error-handler.js'
                },
                {
                    name: 'Main App',
                    test: () => window.ScrollytellingApp,
                    script: '../shared/assets/js/main.js'
                }
            ];
            
            const results = [];
            
            for (let i = 0; i < stages.length; i++) {
                const stage = stages[i];
                updateStatus('loading-status', `Stage ${i+1}: ${stage.name} èª­ã¿è¾¼ã¿ä¸­...`, 'loading');
                
                try {
                    // ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’å‹•çš„ã«èª­ã¿è¾¼ã¿
                    await loadScript(stage.script);
                    await new Promise(resolve => setTimeout(resolve, 100)); // å°‘ã—å¾…æ©Ÿ
                    
                    if (stage.test()) {
                        results.push(`âœ… ${stage.name}: æˆåŠŸ`);
                        updateStatus('loading-status', `Stage ${i+1}: ${stage.name} æˆåŠŸ`, 'success');
                    } else {
                        results.push(`âŒ ${stage.name}: å¤±æ•— (èª­ã¿è¾¼ã¿å¾Œã‚‚æœªå®šç¾©)`);
                        updateStatus('loading-status', `Stage ${i+1}: ${stage.name} å¤±æ•—`, 'error');
                    }
                } catch (error) {
                    results.push(`âŒ ${stage.name}: ã‚¨ãƒ©ãƒ¼ - ${error.message}`);
                    updateStatus('loading-status', `Stage ${i+1}: ${stage.name} ã‚¨ãƒ©ãƒ¼`, 'error');
                }
                
                updateDetails('loading-details', results.join('\n'));
            }
            
            // MainAppã®å®Ÿè¡Œãƒ†ã‚¹ãƒˆ
            if (window.ScrollytellingApp) {
                updateStatus('loading-status', 'Main Appå®Ÿè¡Œãƒ†ã‚¹ãƒˆ...', 'loading');
                try {
                    const app = new window.ScrollytellingApp();
                    results.push('âœ… ScrollytellingApp: ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹åŒ–æˆåŠŸ');
                    updateStatus('loading-status', 'ã™ã¹ã¦ã®ã‚¹ãƒ†ãƒ¼ã‚¸å®Œäº† âœ…', 'success');
                } catch (error) {
                    results.push(`âŒ ScrollytellingAppå®Ÿè¡Œ: ${error.message}`);
                    updateStatus('loading-status', 'Main Appå®Ÿè¡Œå¤±æ•— âŒ', 'error');
                }
            }
            
            updateDetails('loading-details', results.join('\n'));
        }
        
        function loadScript(src) {
            return new Promise((resolve, reject) => {
                const script = document.createElement('script');
                script.src = src;
                script.onload = resolve;
                script.onerror = reject;
                document.head.appendChild(script);
            });
        }
        
        // è¨ºæ–­é–‹å§‹
        window.addEventListener('load', () => {
            setupEnhancedErrorCapture();
            setTimeout(checkDOMElements, 500);
            setTimeout(testStageByStage, 1000);
        });
    </script>

    <!-- éš ã—DOMè¦ç´ ï¼ˆmain.jsãŒè¦æ±‚ã™ã‚‹è¦ç´ ï¼‰ -->
    <div style="display: none;">
        <div id="container"></div>
        <div id="fixed-background"></div>
        <div id="chart-container"></div>
        <div id="map-container"></div>
        <div id="image-container"></div>
        <div id="scroll-content"></div>
        <div id="chart"></div>
        <div id="map"></div>
        <img id="image" />
        <div id="city-steps-container"></div>
        <div class="step" data-step="0"></div>
        <div class="step" data-step="1"></div>
        <div class="step" data-step="2"></div>
    </div>
</body>
</html>