<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Complete Dependencies Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 1200px; margin: 0 auto; }
        .test-section { margin: 15px 0; padding: 15px; background: white; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .result { margin: 10px 0; padding: 12px; border-radius: 6px; }
        .success { background: #d4edda; color: #155724; border-left: 4px solid #28a745; }
        .error { background: #f8d7da; color: #721c24; border-left: 4px solid #dc3545; }
        .warning { background: #fff3cd; color: #856404; border-left: 4px solid #ffc107; }
        .info { background: #d1ecf1; color: #0c5460; border-left: 4px solid #17a2b8; }
        .loading { background: #e2e3e5; color: #6c757d; border-left: 4px solid #6c757d; }
        .progress { width: 100%; background: #e9ecef; border-radius: 4px; overflow: hidden; margin: 10px 0; }
        .progress-bar { height: 20px; background: #007bff; transition: width 0.3s; color: white; text-align: center; line-height: 20px; font-size: 12px; }
        .details { background: #f8f9fa; padding: 10px; margin: 10px 0; border-radius: 4px; font-family: monospace; font-size: 12px; max-height: 300px; overflow-y: auto; }
        .script-item { margin: 5px 0; padding: 5px; border-radius: 3px; }
        .script-loading { background: #fff3cd; }
        .script-success { background: #d4edda; }
        .script-error { background: #f8d7da; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”§ Complete Dependencies Test</h1>
        <p>main.jsã¨ã™ã¹ã¦ã®ä¾å­˜é–¢ä¿‚ã‚’æ®µéšçš„ã«èª­ã¿è¾¼ã¿ã€ã‚¨ãƒ©ãƒ¼ã®ç™ºç”Ÿç®‡æ‰€ã‚’ç‰¹å®šã—ã¾ã™</p>
        
        <div class="test-section">
            <h2>èª­ã¿è¾¼ã¿é€²è¡ŒçŠ¶æ³</h2>
            <div class="progress">
                <div class="progress-bar" id="progress-bar" style="width: 0%">0%</div>
            </div>
            <div id="overall-status" class="result info">æº–å‚™ä¸­...</div>
        </div>

        <div class="test-section">
            <h2>ã‚¹ã‚¯ãƒªãƒ—ãƒˆèª­ã¿è¾¼ã¿è©³ç´°</h2>
            <div id="script-details" class="details"></div>
        </div>

        <div class="test-section">
            <h2>ã‚¨ãƒ©ãƒ¼è©³ç´°</h2>
            <div id="error-log" class="details"></div>
        </div>

        <div class="test-section">
            <h2>æœ€çµ‚çµæœ</h2>
            <div id="final-result" class="result loading">ãƒ†ã‚¹ãƒˆä¸­...</div>
        </div>
    </div>

    <!-- å¿…è¦ãªDOMè¦ç´  -->
    <div style="display: none;">
        <div id="container"></div>
        <div id="fixed-background"></div>
        <div id="chart-container"></div>
        <div id="map-container"></div>
        <div id="image-container"></div>
        <div id="scroll-content"></div>
        <div id="chart"></div>
        <div id="map"></div>
        <img id="image" />
        <div id="city-steps-container"></div>
        <div class="step" data-step="0"></div>
        <div class="step" data-step="1"></div>
        <div class="step" data-step="2"></div>
    </div>

    <!-- å¤–éƒ¨ãƒ©ã‚¤ãƒ–ãƒ©ãƒª -->
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://d3js.org/topojson.v3.min.js"></script>
    <script src="https://unpkg.com/scrollama"></script>
    <script src="../shared/assets/js/libs/d3-labeler.js"></script>

    <script>
        window.DISEASE_TYPE = 'aids';
        window.DIAGNOSIS_MODE = true;
        
        // å®Œå…¨ãªä¾å­˜é–¢ä¿‚ãƒªã‚¹ãƒˆï¼ˆindex.htmlã¨åŒã˜é †åºï¼‰
        const dependencies = [
            // åŸºæœ¬è¨­å®š
            { name: 'Disease Config', path: '../shared/assets/js/config/disease-config.js', test: () => window.DiseaseDetector },
            { name: 'Config Loader', path: '../shared/assets/js/utils/config-loader.js', test: () => window.ConfigLoader },
            { name: 'Defaults', path: '../shared/assets/js/config/defaults.js', test: () => window.AppDefaults },
            
            // å…±é€šãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
            { name: 'App Constants', path: '../shared/assets/js/utils/app-constants.js', test: () => window.AppConstants },
            { name: 'Base Manager', path: '../shared/assets/js/utils/base-manager.js', test: () => window.BaseManager },
            { name: 'SVG Helper', path: '../shared/assets/js/utils/svg-helper.js', test: () => window.SVGHelper },
            { name: 'Error Handler', path: '../shared/assets/js/utils/error-handler.js', test: () => window.ErrorHandler },
            { name: 'Chart Layout Helper', path: '../shared/assets/js/utils/chart-layout-helper.js', test: () => window.ChartLayoutHelper },
            { name: 'Color Scheme', path: '../shared/assets/js/utils/color-scheme.js', test: () => window.ColorScheme },
            { name: 'Country Region Mapping', path: '../shared/assets/js/utils/country-region-mapping.js', test: () => window.CountryRegionMapping },
            { name: 'Position Manager', path: '../shared/assets/js/utils/position-manager.js', test: () => window.PositionManager },
            { name: 'Text Measurement', path: '../shared/assets/js/utils/text-measurement.js', test: () => window.TextMeasurement },
            
            // åœ°å›³ãƒ»éƒ½å¸‚é–¢é€£ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
            { name: 'City Focus Manager', path: '../shared/assets/js/utils/city-focus-manager.js', test: () => window.CityFocusManager },
            { name: 'Map Projection Helper', path: '../shared/assets/js/utils/map-projection-helper.js', test: () => window.MapProjectionHelper },
            { name: 'Map Styling Helper', path: '../shared/assets/js/utils/map-styling-helper.js', test: () => window.MapStylingHelper },
            
            // Chart transitions
            { name: 'Chart Transitions', path: '../shared/assets/js/utils/chart-transitions.js', test: () => window.ChartTransitions },
            
            // Chart renderers
            { name: 'Bar Chart Renderer', path: '../shared/assets/js/bar-chart-renderer.js', test: () => window.BarChartRenderer },
            { name: 'Line Chart Renderer', path: '../shared/assets/js/line-chart-renderer.js', test: () => window.LineChartRenderer },
            { name: 'Pie Chart Renderer', path: '../shared/assets/js/pie-chart-renderer.js', test: () => window.PieChartRenderer },
            { name: 'Grid Chart Renderer', path: '../shared/assets/js/grid-chart-renderer.js', test: () => window.GridChartRenderer },
            
            // ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚¹ã‚¯ãƒªãƒ—ãƒˆ
            { name: 'PubSub', path: '../shared/assets/js/pubsub.js', test: () => window.pubsub },
            { name: 'Chart Manager', path: '../shared/assets/js/chart-manager.js', test: () => window.ChartManager },
            { name: 'Map Manager', path: '../shared/assets/js/map-manager.js', test: () => window.MapManager },
            { name: 'Image Manager', path: '../shared/assets/js/image-manager.js', test: () => window.ImageManager },
            
            // ãƒ¡ã‚¤ãƒ³ã‚¢ãƒ—ãƒªï¼ˆæœ€å¾Œï¼‰
            { name: 'Main App', path: '../shared/assets/js/main.js', test: () => window.ScrollytellingApp }
        ];
        
        let currentIndex = 0;
        let successCount = 0;
        let errorCount = 0;
        const errorLog = [];
        
        // ã‚¨ãƒ©ãƒ¼ã‚­ãƒ£ãƒ—ãƒãƒ£
        window.addEventListener('error', (event) => {
            const errorInfo = {
                type: 'JavaScript Error',
                message: event.error?.message || event.message,
                filename: event.filename?.split('/').pop() || 'Unknown',
                lineno: event.lineno,
                colno: event.colno,
                stack: event.error?.stack,
                timestamp: new Date().toISOString()
            };
            
            errorLog.push(errorInfo);
            updateErrorLog();
        });
        
        function updateProgress() {
            const percentage = Math.round((currentIndex / dependencies.length) * 100);
            const progressBar = document.getElementById('progress-bar');
            progressBar.style.width = `${percentage}%`;
            progressBar.textContent = `${percentage}% (${currentIndex}/${dependencies.length})`;
        }
        
        function updateOverallStatus(message, type) {
            const element = document.getElementById('overall-status');
            element.textContent = message;
            element.className = `result ${type}`;
        }
        
        function addScriptResult(dependency, status, error = null) {
            const details = document.getElementById('script-details');
            const item = document.createElement('div');
            item.className = `script-item script-${status}`;
            
            let content = `${currentIndex}. ${dependency.name}: `;
            
            if (status === 'success') {
                content += 'âœ… æˆåŠŸ';
                successCount++;
            } else if (status === 'error') {
                content += `âŒ å¤±æ•— - ${error}`;
                errorCount++;
            } else {
                content += 'ğŸ”„ èª­ã¿è¾¼ã¿ä¸­...';
            }
            
            item.textContent = content;
            details.appendChild(item);
            
            // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã—ã¦æœ€æ–°ã‚’è¡¨ç¤º
            details.scrollTop = details.scrollHeight;
        }
        
        function updateErrorLog() {
            const errorLogElement = document.getElementById('error-log');
            errorLogElement.innerHTML = errorLog.map((error, index) => 
                `[${index + 1}] ${error.type}
File: ${error.filename}:${error.lineno}:${error.colno}
Message: ${error.message}
Time: ${error.timestamp}
${error.stack ? `Stack: ${error.stack.substring(0, 200)}...` : ''}
---`
            ).join('\n');
        }
        
        function loadScript(dependency) {
            return new Promise((resolve, reject) => {
                addScriptResult(dependency, 'loading');
                
                const script = document.createElement('script');
                script.src = dependency.path;
                
                script.onload = () => {
                    // å°‘ã—å¾…ã£ã¦ã‹ã‚‰ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
                    setTimeout(() => {
                        try {
                            if (dependency.test()) {
                                addScriptResult(dependency, 'success');
                                resolve(true);
                            } else {
                                addScriptResult(dependency, 'error', 'ãƒ†ã‚¹ãƒˆé–¢æ•°ãŒfalseã‚’è¿”ã—ã¾ã—ãŸ');
                                resolve(false);
                            }
                        } catch (testError) {
                            addScriptResult(dependency, 'error', `ãƒ†ã‚¹ãƒˆå®Ÿè¡Œã‚¨ãƒ©ãƒ¼: ${testError.message}`);
                            resolve(false);
                        }
                    }, 100);
                };
                
                script.onerror = (error) => {
                    addScriptResult(dependency, 'error', 'ã‚¹ã‚¯ãƒªãƒ—ãƒˆèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼');
                    resolve(false);
                };
                
                document.head.appendChild(script);
            });
        }
        
        async function runCompleteTest() {
            updateOverallStatus('ãƒ†ã‚¹ãƒˆé–‹å§‹...', 'info');
            
            for (const dependency of dependencies) {
                currentIndex++;
                updateProgress();
                updateOverallStatus(`èª­ã¿è¾¼ã¿ä¸­: ${dependency.name}`, 'loading');
                
                try {
                    await loadScript(dependency);
                    
                    // ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¦ã„ã‚‹å ´åˆã¯ä¸€æ—¦åœæ­¢
                    if (errorLog.length > 0) {
                        updateOverallStatus(`ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿã«ã‚ˆã‚Šåœæ­¢: ${dependency.name}`, 'error');
                        break;
                    }
                    
                } catch (error) {
                    updateOverallStatus(`äºˆæœŸã—ãªã„ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
                    break;
                }
                
                // æ¬¡ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆèª­ã¿è¾¼ã¿å‰ã«å°‘ã—å¾…æ©Ÿ
                await new Promise(resolve => setTimeout(resolve, 200));
            }
            
            // æœ€çµ‚çµæœ
            const finalResult = document.getElementById('final-result');
            if (errorLog.length > 0) {
                finalResult.textContent = `âŒ ãƒ†ã‚¹ãƒˆå¤±æ•—: ${errorLog.length}å€‹ã®ã‚¨ãƒ©ãƒ¼ (æˆåŠŸ: ${successCount}, å¤±æ•—: ${errorCount})`;
                finalResult.className = 'result error';
            } else if (successCount === dependencies.length) {
                finalResult.textContent = `âœ… ã™ã¹ã¦æˆåŠŸ: ${successCount}/${dependencies.length}`;
                finalResult.className = 'result success';
                
                // ScrollytellingAppå®Ÿè¡Œãƒ†ã‚¹ãƒˆ
                if (window.ScrollytellingApp) {
                    try {
                        updateOverallStatus('ScrollytellingAppå®Ÿè¡Œãƒ†ã‚¹ãƒˆ...', 'loading');
                        const app = new window.ScrollytellingApp();
                        finalResult.textContent += ' - ã‚¢ãƒ—ãƒªå®Ÿè¡ŒæˆåŠŸ âœ…';
                    } catch (appError) {
                        finalResult.textContent += ` - ã‚¢ãƒ—ãƒªå®Ÿè¡Œå¤±æ•—: ${appError.message} âŒ`;
                        finalResult.className = 'result error';
                    }
                }
            } else {
                finalResult.textContent = `âš ï¸ éƒ¨åˆ†çš„æˆåŠŸ: ${successCount}/${dependencies.length}`;
                finalResult.className = 'result warning';
            }
            
            updateOverallStatus('ãƒ†ã‚¹ãƒˆå®Œäº†', 'success');
        }
        
        // ãƒ†ã‚¹ãƒˆé–‹å§‹
        window.addEventListener('load', () => {
            setTimeout(runCompleteTest, 500);
        });
    </script>
</body>
</html>