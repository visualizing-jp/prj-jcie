<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>New ChartManager Test</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 20px;
            background-color: #f8fafc;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        h1 {
            color: #1e293b;
            text-align: center;
            margin-bottom: 30px;
        }
        .test-section {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        .test-controls {
            margin-bottom: 20px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        button {
            padding: 8px 16px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            background: #f9fafb;
            cursor: pointer;
            font-size: 14px;
        }
        button:hover {
            background: #f3f4f6;
        }
        button.active {
            background: #3b82f6;
            color: white;
            border-color: #3b82f6;
        }
        #chart {
            min-height: 400px;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            background: white;
        }
        .chart-error {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 200px;
            color: #6b7280;
            text-align: center;
        }
        .debug-info {
            background: #f1f5f9;
            border: 1px solid #cbd5e1;
            border-radius: 6px;
            padding: 15px;
            margin-top: 20px;
            font-family: 'Monaco', 'Consolas', monospace;
            font-size: 12px;
            white-space: pre-wrap;
        }
        .status {
            padding: 10px;
            border-radius: 6px;
            margin-bottom: 10px;
        }
        .status.success {
            background: #dcfce7;
            color: #166534;
            border: 1px solid #bbf7d0;
        }
        .status.error {
            background: #fef2f2;
            color: #dc2626;
            border: 1px solid #fecaca;
        }
        .status.warning {
            background: #fffbeb;
            color: #d97706;
            border: 1px solid #fed7aa;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>New ChartManager Test</h1>
        
        <div id="status" class="status"></div>
        
        <div class="test-section">
            <h3>Chart Controls</h3>
            <div class="test-controls">
                <button onclick="testLineChart()">Line Chart</button>
                <button onclick="testBarChart()">Bar Chart</button>
                <button onclick="testPieChart()">Pie Chart</button>
                <button onclick="testDualLayout()">Dual Layout</button>
                <button onclick="testTripleLayout()">Triple Layout</button>
                <button onclick="testGridLayout()">Grid Layout</button>
                <button onclick="hideChart()">Hide</button>
                <button onclick="showDebugInfo()">Debug Info</button>
            </div>
            
            <div id="chart"></div>
            
            <div id="debug" class="debug-info" style="display: none;"></div>
        </div>
    </div>

    <!-- Load required scripts -->
    <script src="assets/js/pubsub.js"></script>
    <script src="assets/js/config/defaults.js"></script>
    <script src="assets/js/utils/base-manager.js"></script>
    <script src="assets/js/utils/ChartTransitions.js"></script>
    <script src="assets/js/utils/svg-helper.js"></script>
    <script src="assets/js/utils/chart-layout-helper.js"></script>
    <script src="assets/js/utils/color-scheme.js"></script>
    <script src="assets/js/LineChartRenderer.js"></script>
    <script src="assets/js/BarChartRenderer.js"></script>
    <script src="assets/js/PieChartRenderer.js"></script>
    <script src="assets/js/GridChartRenderer.js"></script>
    <script src="assets/js/ChartManager.js"></script>

    <script>
        // Initialize chart manager
        let chartManager;
        
        // Sample data
        const lineData = [
            { year: 2010, value: 10, series: 'Series A' },
            { year: 2011, value: 15, series: 'Series A' },
            { year: 2012, value: 20, series: 'Series A' },
            { year: 2013, value: 18, series: 'Series A' },
            { year: 2014, value: 25, series: 'Series A' },
            { year: 2010, value: 5, series: 'Series B' },
            { year: 2011, value: 8, series: 'Series B' },
            { year: 2012, value: 12, series: 'Series B' },
            { year: 2013, value: 15, series: 'Series B' },
            { year: 2014, value: 20, series: 'Series B' }
        ];
        
        const barData = [
            { category: 'A', value: 30 },
            { category: 'B', value: 25 },
            { category: 'C', value: 40 },
            { category: 'D', value: 35 }
        ];
        
        const pieData = [
            { label: 'Category 1', value: 30 },
            { label: 'Category 2', value: 25 },
            { label: 'Category 3', value: 20 },
            { label: 'Category 4', value: 25 }
        ];

        function updateStatus(message, type = 'success') {
            const status = document.getElementById('status');
            status.textContent = message;
            status.className = `status ${type}`;
        }

        // Initialize when DOM is ready
        document.addEventListener('DOMContentLoaded', function() {
            try {
                // Check if all required components are available
                const required = [
                    'BaseManager', 'ChartTransitions', 'LineChartRenderer', 
                    'BarChartRenderer', 'PieChartRenderer', 'GridChartRenderer', 
                    'ChartManager'
                ];
                
                const missing = required.filter(component => !window[component]);
                
                if (missing.length > 0) {
                    updateStatus(`Missing components: ${missing.join(', ')}`, 'error');
                    return;
                }
                
                // Initialize ChartManager
                chartManager = new ChartManager('#chart');
                updateStatus('ChartManager initialized successfully');
                
                // Test basic functionality
                testLineChart();
                
            } catch (error) {
                updateStatus(`Initialization error: ${error.message}`, 'error');
                console.error('ChartManager initialization failed:', error);
            }
        });

        function testLineChart() {
            if (!chartManager) {
                updateStatus('ChartManager not initialized', 'error');
                return;
            }
            
            try {
                chartManager.updateChart({
                    type: 'line',
                    data: lineData,
                    config: {
                        xField: 'year',
                        yField: 'value',
                        seriesField: 'series',
                        multiSeries: true,
                        title: 'Test Line Chart',
                        colors: ['#3b82f6', '#ef4444']
                    },
                    visible: true
                });
                
                updateStatus('Line chart rendered successfully');
                setActiveButton(event.target);
            } catch (error) {
                updateStatus(`Line chart error: ${error.message}`, 'error');
                console.error('Line chart error:', error);
            }
        }

        function testBarChart() {
            if (!chartManager) {
                updateStatus('ChartManager not initialized', 'error');
                return;
            }
            
            try {
                chartManager.updateChart({
                    type: 'bar',
                    data: barData,
                    config: {
                        xField: 'category',
                        yField: 'value',
                        title: 'Test Bar Chart',
                        color: '#10b981'
                    },
                    visible: true
                });
                
                updateStatus('Bar chart rendered successfully');
                setActiveButton(event.target);
            } catch (error) {
                updateStatus(`Bar chart error: ${error.message}`, 'error');
                console.error('Bar chart error:', error);
            }
        }

        function testPieChart() {
            if (!chartManager) {
                updateStatus('ChartManager not initialized', 'error');
                return;
            }
            
            try {
                chartManager.updateChart({
                    type: 'pie',
                    data: pieData,
                    config: {
                        labelField: 'label',
                        valueField: 'value',
                        title: 'Test Pie Chart'
                    },
                    visible: true
                });
                
                updateStatus('Pie chart rendered successfully');
                setActiveButton(event.target);
            } catch (error) {
                updateStatus(`Pie chart error: ${error.message}`, 'error');
                console.error('Pie chart error:', error);
            }
        }

        function testDualLayout() {
            if (!chartManager) {
                updateStatus('ChartManager not initialized', 'error');
                return;
            }
            
            try {
                chartManager.updateChart({
                    layout: 'dual',
                    charts: [
                        {
                            title: 'Chart A',
                            data: lineData.filter(d => d.series === 'Series A'),
                            config: {
                                type: 'line',
                                xField: 'year',
                                yField: 'value',
                                multiSeries: false,
                                colors: ['#3b82f6']
                            }
                        },
                        {
                            title: 'Chart B',
                            data: lineData.filter(d => d.series === 'Series B'),
                            config: {
                                type: 'line',
                                xField: 'year',
                                yField: 'value',
                                multiSeries: false,
                                colors: ['#ef4444']
                            }
                        }
                    ],
                    visible: true
                });
                
                updateStatus('Dual layout rendered successfully');
                setActiveButton(event.target);
            } catch (error) {
                updateStatus(`Dual layout error: ${error.message}`, 'error');
                console.error('Dual layout error:', error);
            }
        }

        function testTripleLayout() {
            if (!chartManager) {
                updateStatus('ChartManager not initialized', 'error');
                return;
            }
            
            try {
                chartManager.updateChart({
                    layout: 'triple',
                    charts: [
                        {
                            title: 'Pie Chart',
                            data: pieData.slice(0, 3),
                            config: {
                                type: 'pie',
                                labelField: 'label',
                                valueField: 'value'
                            }
                        },
                        {
                            title: 'Bar Chart',
                            data: barData.slice(0, 3),
                            config: {
                                type: 'bar',
                                xField: 'category',
                                yField: 'value'
                            }
                        },
                        {
                            title: 'Line Chart',
                            data: lineData.filter(d => d.series === 'Series A'),
                            config: {
                                type: 'line',
                                xField: 'year',
                                yField: 'value',
                                multiSeries: false
                            }
                        }
                    ],
                    visible: true
                });
                
                updateStatus('Triple layout rendered successfully');
                setActiveButton(event.target);
            } catch (error) {
                updateStatus(`Triple layout error: ${error.message}`, 'error');
                console.error('Triple layout error:', error);
            }
        }

        function testGridLayout() {
            if (!chartManager) {
                updateStatus('ChartManager not initialized', 'error');
                return;
            }
            
            try {
                chartManager.updateChart({
                    layout: 'grid',
                    config: {
                        gridRows: 2,
                        gridCols: 2,
                        charts: [
                            { data: pieData, config: { type: 'pie' } },
                            { data: barData, config: { type: 'bar' } },
                            { data: lineData, config: { type: 'line' } },
                            { data: pieData, config: { type: 'pie' } }
                        ]
                    },
                    visible: true
                });
                
                updateStatus('Grid layout rendered successfully');
                setActiveButton(event.target);
            } catch (error) {
                updateStatus(`Grid layout error: ${error.message}`, 'error');
                console.error('Grid layout error:', error);
            }
        }

        function hideChart() {
            if (!chartManager) {
                updateStatus('ChartManager not initialized', 'error');
                return;
            }
            
            try {
                chartManager.hide();
                updateStatus('Chart hidden successfully');
                setActiveButton(event.target);
            } catch (error) {
                updateStatus(`Hide error: ${error.message}`, 'error');
                console.error('Hide error:', error);
            }
        }

        function showDebugInfo() {
            if (!chartManager) {
                updateStatus('ChartManager not initialized', 'error');
                return;
            }
            
            try {
                const debugInfo = chartManager.getDebugInfo();
                const debugDiv = document.getElementById('debug');
                debugDiv.textContent = JSON.stringify(debugInfo, null, 2);
                debugDiv.style.display = debugDiv.style.display === 'none' ? 'block' : 'none';
                
                updateStatus('Debug info toggled');
            } catch (error) {
                updateStatus(`Debug info error: ${error.message}`, 'error');
                console.error('Debug info error:', error);
            }
        }

        function setActiveButton(button) {
            // Remove active class from all buttons
            document.querySelectorAll('button').forEach(btn => btn.classList.remove('active'));
            // Add active class to clicked button
            if (button) {
                button.classList.add('active');
            }
        }

        // Handle resize
        window.addEventListener('resize', function() {
            if (chartManager) {
                chartManager.resize();
            }
        });
    </script>
</body>
</html>