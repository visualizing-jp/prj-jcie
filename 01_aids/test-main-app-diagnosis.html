<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Main App Diagnosis</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .test-section { margin: 15px 0; padding: 15px; background: white; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .result { margin: 10px 0; padding: 12px; border-radius: 6px; }
        .success { background: #d4edda; color: #155724; border-left: 4px solid #28a745; }
        .error { background: #f8d7da; color: #721c24; border-left: 4px solid #dc3545; }
        .warning { background: #fff3cd; color: #856404; border-left: 4px solid #ffc107; }
        .info { background: #d1ecf1; color: #0c5460; border-left: 4px solid #17a2b8; }
        .loading { background: #e2e3e5; color: #6c757d; border-left: 4px solid #6c757d; }
        .progress { width: 100%; background: #e9ecef; border-radius: 4px; overflow: hidden; }
        .progress-bar { height: 20px; background: #007bff; transition: width 0.3s; }
        .detail-box { background: #f8f9fa; padding: 10px; margin: 10px 0; border-radius: 4px; font-family: monospace; font-size: 12px; max-height: 200px; overflow-y: auto; }
        .step-counter { float: right; background: #007bff; color: white; padding: 4px 8px; border-radius: 12px; font-size: 12px; }
    </style>
</head>
<body>
    <h1>ğŸ”¬ Main App Diagnosis</h1>
    <p>index.htmlã®å‹•ä½œã‚’è©³ç´°è¨ºæ–­ã—ã€å•é¡Œã‚’ç‰¹å®šã—ã¾ã™</p>
    
    <div class="progress">
        <div class="progress-bar" id="overall-progress" style="width: 0%"></div>
    </div>
    <div id="progress-text" style="margin: 10px 0; font-weight: bold;">è¨ºæ–­æº–å‚™ä¸­...</div>

    <div class="test-section">
        <h2>1. åŸºç›¤ã‚·ã‚¹ãƒ†ãƒ ç¢ºèª <span class="step-counter" id="step1-counter">0/7</span></h2>
        <div id="foundation-result" class="result loading">ãƒ†ã‚¹ãƒˆä¸­...</div>
        <div id="foundation-details" class="detail-box"></div>
    </div>
    
    <div class="test-section">
        <h2>2. ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ç¢ºèª <span class="step-counter" id="step2-counter">0/5</span></h2>
        <div id="data-loading-result" class="result loading">å¾…æ©Ÿä¸­...</div>
        <div id="data-details" class="detail-box"></div>
    </div>
    
    <div class="test-section">
        <h2>3. ManageråˆæœŸåŒ–ç¢ºèª <span class="step-counter" id="step3-counter">0/4</span></h2>
        <div id="manager-result" class="result loading">å¾…æ©Ÿä¸­...</div>
        <div id="manager-details" class="detail-box"></div>
    </div>
    
    <div class="test-section">
        <h2>4. DOMè¦ç´ ç¢ºèª <span class="step-counter" id="step4-counter">0/6</span></h2>
        <div id="dom-result" class="result loading">å¾…æ©Ÿä¸­...</div>
        <div id="dom-details" class="detail-box"></div>
    </div>
    
    <div class="test-section">
        <h2>5. Scrollamaè¨­å®šç¢ºèª <span class="step-counter" id="step5-counter">0/3</span></h2>
        <div id="scrollama-result" class="result loading">å¾…æ©Ÿä¸­...</div>
        <div id="scrollama-details" class="detail-box"></div>
    </div>
    
    <div class="test-section">
        <h2>6. æœ€çµ‚è¨ºæ–­çµæœ</h2>
        <div id="final-result" class="result loading">è¨ºæ–­ä¸­...</div>
        <div id="recommendations" class="detail-box"></div>
    </div>

    <!-- éš ã—DOMè¦ç´  (main.jsã®è¦æ±‚ã«å¯¾å¿œ) -->
    <div style="display: none;">
        <div id="container"></div>
        <div id="fixed-background"></div>
        <div id="chart-container"></div>
        <div id="map-container"></div>
        <div id="image-container"></div>
        <div id="scroll-content"></div>
        <div id="chart"></div>
        <div id="map"></div>
        <img id="image" />
        <!-- ã„ãã¤ã‹ã®ã‚¹ãƒ†ãƒƒãƒ—è¦ç´ ã‚‚è¿½åŠ  -->
        <div class="step" data-step="0"></div>
        <div class="step" data-step="1"></div>
        <div class="step" data-step="2"></div>
    </div>

    <!-- æ„ŸæŸ“ç—‡è¨­å®š -->
    <script>
        window.DISEASE_TYPE = 'aids';
        
        // è¨ºæ–­ãƒ¢ãƒ¼ãƒ‰: ScrollytellingAppã®è‡ªå‹•åˆæœŸåŒ–ã‚’é˜²ã
        window.DIAGNOSIS_MODE = true;
        
        // è¨ºæ–­çŠ¶æ…‹ç®¡ç†
        const diagnosis = {
            currentStep: 0,
            totalSteps: 5,
            stepProgress: [0, 0, 0, 0, 0],
            stepMax: [7, 5, 4, 6, 3],
            errors: [],
            warnings: [],
            details: {}
        };
        
        function updateProgress() {
            const overallProgress = (diagnosis.currentStep / diagnosis.totalSteps) * 100;
            document.getElementById('overall-progress').style.width = `${overallProgress}%`;
            document.getElementById('progress-text').textContent = 
                `ã‚¹ãƒ†ãƒƒãƒ— ${diagnosis.currentStep}/${diagnosis.totalSteps} - ${Math.round(overallProgress)}% å®Œäº†`;
        }
        
        function updateStepCounter(step, current, max) {
            document.getElementById(`step${step}-counter`).textContent = `${current}/${max}`;
            diagnosis.stepProgress[step - 1] = current;
        }
        
        function setResult(elementId, message, type, details = '') {
            document.getElementById(elementId).innerHTML = message;
            document.getElementById(elementId).className = `result ${type}`;
            if (details) {
                const detailsId = elementId.replace('-result', '-details');
                document.getElementById(detailsId).innerHTML = details;
            }
        }
    </script>
    
    <!-- Shared System -->
    <script src="../shared/assets/js/config/disease-config.js"></script>
    <script src="../shared/assets/js/utils/config-loader.js"></script>
    <script src="../shared/assets/js/config/defaults.js"></script>
    <script src="../shared/assets/js/utils/app-constants.js"></script>
    <script src="../shared/assets/js/utils/base-manager.js"></script>
    <script src="../shared/assets/js/utils/error-handler.js"></script>
    <script src="../shared/assets/js/pubsub.js"></script>
    
    <!-- Core Managers -->
    <script src="../shared/assets/js/chart-manager.js"></script>
    <script src="../shared/assets/js/map-manager.js"></script>
    <script src="../shared/assets/js/image-manager.js"></script>
    
    <!-- Main App (ä¿®æ­£ç‰ˆ) -->
    <script src="../shared/assets/js/main.js"></script>

    <script>
        async function runMainAppDiagnosis() {
            try {
                // Step 1: åŸºç›¤ã‚·ã‚¹ãƒ†ãƒ ç¢ºèª
                diagnosis.currentStep = 1;
                updateProgress();
                await testFoundationSystems();
                
                // Step 2: ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ç¢ºèª
                diagnosis.currentStep = 2;
                updateProgress();
                await testDataLoading();
                
                // Step 3: ManageråˆæœŸåŒ–ç¢ºèª
                diagnosis.currentStep = 3;
                updateProgress();
                await testManagerInitialization();
                
                // Step 4: DOMè¦ç´ ç¢ºèª
                diagnosis.currentStep = 4;
                updateProgress();
                await testDOMElements();
                
                // Step 5: Scrollamaè¨­å®šç¢ºèª
                diagnosis.currentStep = 5;
                updateProgress();
                await testScrollamaSetup();
                
                // æœ€çµ‚è¨ºæ–­
                diagnosis.currentStep = 5;
                updateProgress();
                generateFinalDiagnosis();
                
            } catch (error) {
                diagnosis.errors.push(`Critical Error: ${error.message}`);
                setResult('final-result', `âŒ é‡å¤§ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
                console.error('Diagnosis failed:', error);
            }
        }
        
        async function testFoundationSystems() {
            let passed = 0;
            const tests = [
                { name: 'DISEASE_TYPE', test: () => window.DISEASE_TYPE === 'aids' },
                { name: 'DiseaseDetector', test: () => !!window.DiseaseDetector },
                { name: 'ConfigLoader', test: () => !!window.ConfigLoader },
                { name: 'PubSub', test: () => !!window.pubsub },
                { name: 'BaseManager', test: () => !!window.BaseManager },
                { name: 'ErrorHandler', test: () => !!window.ErrorHandler },
                { name: 'Config Loading', test: async () => {
                    await window.ConfigLoader.loadAll();
                    return !!window.ConfigLoader.getLegacyCompatibleConfig().steps;
                }}
            ];
            
            const results = [];
            for (const test of tests) {
                try {
                    const result = await test.test();
                    if (result) {
                        passed++;
                        results.push(`âœ… ${test.name}`);
                    } else {
                        results.push(`âŒ ${test.name}`);
                        diagnosis.errors.push(`Foundation: ${test.name} failed`);
                    }
                } catch (error) {
                    results.push(`âŒ ${test.name}: ${error.message}`);
                    diagnosis.errors.push(`Foundation: ${test.name} error - ${error.message}`);
                }
                updateStepCounter(1, passed, tests.length);
            }
            
            const success = passed >= 6;
            setResult('foundation-result', 
                success ? `âœ… åŸºç›¤ã‚·ã‚¹ãƒ†ãƒ æ­£å¸¸ (${passed}/${tests.length})` : `âŒ åŸºç›¤ã‚·ã‚¹ãƒ†ãƒ å•é¡Œ (${passed}/${tests.length})`,
                success ? 'success' : 'error',
                results.join('<br>')
            );
        }
        
        async function testDataLoading() {
            let passed = 0;
            const results = [];
            
            try {
                // ConfigLoaderã®ãƒ‡ãƒ¼ã‚¿ãƒ‘ã‚¹è§£æ±ºãƒ†ã‚¹ãƒˆ
                const testPaths = [
                    'cities-timeline.json',
                    'countries-110m.json', 
                    'trend_new_infections_normalized.csv',
                    'ratio_æŠ—HIVæ²»ç™‚.csv'
                ];
                
                for (const path of testPaths) {
                    try {
                        const resolvedPath = window.ConfigLoader.resolveDataPath(path);
                        const response = await fetch(resolvedPath);
                        if (response.ok) {
                            passed++;
                            results.push(`âœ… ${path} (${response.status})`);
                        } else {
                            results.push(`âŒ ${path} (HTTP ${response.status})`);
                            diagnosis.errors.push(`Data: ${path} HTTP ${response.status}`);
                        }
                    } catch (error) {
                        results.push(`âŒ ${path}: ${error.message}`);
                        diagnosis.errors.push(`Data: ${path} - ${error.message}`);
                    }
                    updateStepCounter(2, passed, testPaths.length + 1);
                }
                
                // Main.js ScrollytellingApp ç¢ºèª
                if (window.ScrollytellingApp) {
                    passed++;
                    results.push(`âœ… ScrollytellingApp class available`);
                } else {
                    results.push(`âŒ ScrollytellingApp class not found`);
                    diagnosis.errors.push(`Data: ScrollytellingApp class missing`);
                }
                
            } catch (error) {
                diagnosis.errors.push(`Data Loading: ${error.message}`);
            }
            
            updateStepCounter(2, passed, 5);
            const success = passed >= 4;
            setResult('data-loading-result',
                success ? `âœ… ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿æ­£å¸¸ (${passed}/5)` : `âŒ ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿å•é¡Œ (${passed}/5)`,
                success ? 'success' : 'error',
                results.join('<br>')
            );
        }
        
        async function testManagerInitialization() {
            let passed = 0;
            const results = [];
            const managers = ['ChartManager', 'MapManager', 'ImageManager'];
            
            for (const manager of managers) {
                if (window[manager]) {
                    passed++;
                    results.push(`âœ… ${manager} class available`);
                } else {
                    results.push(`âŒ ${manager} class not found`);
                    diagnosis.errors.push(`Manager: ${manager} missing`);
                }
                updateStepCounter(3, passed, 4);
            }
            
            // Manager instantiation test
            try {
                if (window.ChartManager) {
                    const testChart = new window.ChartManager('test-container');
                    passed++;
                    results.push(`âœ… Manager instantiation test passed`);
                } else {
                    results.push(`âŒ Cannot test manager instantiation`);
                }
            } catch (error) {
                results.push(`âŒ Manager instantiation failed: ${error.message}`);
                diagnosis.warnings.push(`Manager instantiation: ${error.message}`);
            }
            
            updateStepCounter(3, passed, 4);
            const success = passed >= 3;
            setResult('manager-result',
                success ? `âœ… ManageråˆæœŸåŒ–æ­£å¸¸ (${passed}/4)` : `âŒ ManageråˆæœŸåŒ–å•é¡Œ (${passed}/4)`,
                success ? 'success' : 'error',
                results.join('<br>')
            );
        }
        
        async function testDOMElements() {
            let passed = 0;
            const results = [];
            const requiredElements = [
                'container',
                'fixed-background', 
                'chart-container',
                'map-container',
                'image-container',
                'scroll-content'
            ];
            
            for (const elementId of requiredElements) {
                const element = document.getElementById(elementId);
                if (element) {
                    passed++;
                    results.push(`âœ… #${elementId} found`);
                } else {
                    results.push(`âŒ #${elementId} missing`);
                    diagnosis.warnings.push(`DOM: #${elementId} element missing`);
                }
                updateStepCounter(4, passed, requiredElements.length);
            }
            
            const success = passed >= 4;
            setResult('dom-result',
                success ? `âœ… DOMè¦ç´ ç¢ºèª (${passed}/${requiredElements.length}) - ${passed < requiredElements.length ? 'ä¸€éƒ¨ä¸è¶³ã ãŒå‹•ä½œå¯èƒ½' : 'å®Œå…¨'}` : `âŒ DOMè¦ç´ ä¸è¶³ (${passed}/${requiredElements.length})`,
                success ? (passed === requiredElements.length ? 'success' : 'warning') : 'error',
                results.join('<br>')
            );
        }
        
        async function testScrollamaSetup() {
            let passed = 0;
            const results = [];
            
            // Scrollama library check
            if (window.scrollama) {
                passed++;
                results.push(`âœ… Scrollama library loaded`);
            } else {
                results.push(`âŒ Scrollama library not found`);
                diagnosis.errors.push(`Scrollama: Library not loaded`);
            }
            updateStepCounter(5, passed, 3);
            
            // Step elements check
            const stepElements = document.querySelectorAll('.step[data-step]');
            if (stepElements.length > 0) {
                passed++;
                results.push(`âœ… Step elements found (${stepElements.length} steps)`);
            } else {
                results.push(`âŒ No step elements found`);
                diagnosis.warnings.push(`Scrollama: No .step[data-step] elements`);
            }
            updateStepCounter(5, passed, 3);
            
            // CSS classes check
            const hasStepClass = document.querySelector('.step') !== null;
            if (hasStepClass) {
                passed++;
                results.push(`âœ… Step CSS classes present`);
            } else {
                results.push(`âŒ Step CSS classes missing`);
                diagnosis.warnings.push(`Scrollama: .step CSS classes missing`);
            }
            updateStepCounter(5, passed, 3);
            
            const success = passed >= 2;
            setResult('scrollama-result',
                success ? `âœ… Scrollamaè¨­å®šç¢ºèª (${passed}/3)` : `âŒ Scrollamaè¨­å®šå•é¡Œ (${passed}/3)`,
                success ? 'success' : 'error',
                results.join('<br>')
            );
        }
        
        function generateFinalDiagnosis() {
            const totalErrors = diagnosis.errors.length;
            const totalWarnings = diagnosis.warnings.length;
            const totalPassed = diagnosis.stepProgress.reduce((a, b) => a + b, 0);
            const totalMax = diagnosis.stepMax.reduce((a, b) => a + b, 0);
            
            let status, recommendation;
            if (totalErrors === 0 && totalWarnings <= 2) {
                status = 'success';
                recommendation = `
                    <strong>ğŸ‰ è¨ºæ–­å®Œäº†: ãƒ¡ã‚¤ãƒ³ã‚¢ãƒ—ãƒªæ­£å¸¸å‹•ä½œ</strong><br>
                    <strong>æˆåŠŸç‡:</strong> ${totalPassed}/${totalMax} (${Math.round((totalPassed/totalMax)*100)}%)<br>
                    <strong>æ¨å¥¨:</strong> index.htmlã§ã®å®Ÿéš›ã®Scrollytellingæ©Ÿèƒ½ãƒ†ã‚¹ãƒˆã«é€²ã‚“ã§ãã ã•ã„
                `;
            } else if (totalErrors <= 2) {
                status = 'warning';
                recommendation = `
                    <strong>âš ï¸ è¨ºæ–­å®Œäº†: ä¸€éƒ¨å•é¡Œã‚ã‚Š</strong><br>
                    <strong>æˆåŠŸç‡:</strong> ${totalPassed}/${totalMax} (${Math.round((totalPassed/totalMax)*100)}%)<br>
                    <strong>ã‚¨ãƒ©ãƒ¼:</strong> ${totalErrors}å€‹, <strong>è­¦å‘Š:</strong> ${totalWarnings}å€‹<br>
                    <strong>æ¨å¥¨:</strong> è»½å¾®ãªå•é¡Œã®ãŸã‚ã€æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆã¯å¯èƒ½ã§ã™ãŒä¿®æ­£ã‚’æ¨å¥¨
                `;
            } else {
                status = 'error';
                recommendation = `
                    <strong>âŒ è¨ºæ–­å®Œäº†: é‡å¤§ãªå•é¡Œ</strong><br>
                    <strong>æˆåŠŸç‡:</strong> ${totalPassed}/${totalMax} (${Math.round((totalPassed/totalMax)*100)}%)<br>
                    <strong>ã‚¨ãƒ©ãƒ¼:</strong> ${totalErrors}å€‹, <strong>è­¦å‘Š:</strong> ${totalWarnings}å€‹<br>
                    <strong>æ¨å¥¨:</strong> ä»¥ä¸‹ã®å•é¡Œã‚’ä¿®æ­£ã—ã¦ã‹ã‚‰æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆã«é€²ã‚“ã§ãã ã•ã„
                `;
            }
            
            const detailedReport = `
                <strong>è©³ç´°ãƒ¬ãƒãƒ¼ãƒˆ:</strong><br>
                ${diagnosis.errors.length > 0 ? '<strong>ã‚¨ãƒ©ãƒ¼:</strong><br>' + diagnosis.errors.map(e => `â€¢ ${e}`).join('<br>') + '<br><br>' : ''}
                ${diagnosis.warnings.length > 0 ? '<strong>è­¦å‘Š:</strong><br>' + diagnosis.warnings.map(w => `â€¢ ${w}`).join('<br>') + '<br><br>' : ''}
                <strong>æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—:</strong><br>
                ${status === 'success' ? 
                    'â€¢ index.htmlã§Scrollytellingæ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ<br>â€¢ ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«é€£å‹•ãƒ†ã‚¹ãƒˆ<br>â€¢ ãƒãƒ£ãƒ¼ãƒˆãƒ»åœ°å›³è¡¨ç¤ºãƒ†ã‚¹ãƒˆ' :
                    'â€¢ ä¸Šè¨˜å•é¡Œã®ä¿®æ­£<br>â€¢ ä¿®æ­£å¾Œã®å†è¨ºæ–­<br>â€¢ æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ'
                }
            `;
            
            setResult('final-result', recommendation, status, detailedReport);
        }
        
        // è¨ºæ–­é–‹å§‹
        window.addEventListener('load', () => {
            setTimeout(runMainAppDiagnosis, 500);
        });
    </script>
</body>
</html>